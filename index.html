<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <title></title>
  <meta name="Generator" content="Cocoa HTML Writer">
  <meta name="CocoaVersion" content="2566">
  <style type="text/css">
    p.p1 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Helvetica}
    p.p2 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Helvetica; min-height: 14.0px}
  </style>
</head>
<body>
<p class="p1">&lt;!DOCTYPE html&gt;</p>
<p class="p1">&lt;html lang="es"&gt;</p>
<p class="p1">&lt;head&gt;</p>
<p class="p1"><span class="Apple-converted-space">  </span>&lt;meta charset="UTF-8"&gt;</p>
<p class="p1"><span class="Apple-converted-space">  </span>&lt;title&gt;Transformación de Coordenadas a Pixel&lt;/title&gt;</p>
<p class="p1"><span class="Apple-converted-space">  </span>&lt;style&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>body { font-family: Arial, sans-serif; }</p>
<p class="p1"><span class="Apple-converted-space">    </span>#mapContainer { position: relative; width: 800px; margin: auto; }</p>
<p class="p1"><span class="Apple-converted-space">    </span>/* El tamaño del contenedor dependerá de tu imagen. Ajusta según sea necesario */</p>
<p class="p1"><span class="Apple-converted-space">    </span>#mapImg { width: 100%; display: block; }</p>
<p class="p1"><span class="Apple-converted-space">    </span>.marker {</p>
<p class="p1"><span class="Apple-converted-space">      </span>position: absolute;</p>
<p class="p1"><span class="Apple-converted-space">      </span>width: 12px;</p>
<p class="p1"><span class="Apple-converted-space">      </span>height: 12px;</p>
<p class="p1"><span class="Apple-converted-space">      </span>border-radius: 50%;</p>
<p class="p1"><span class="Apple-converted-space">      </span>border: 1px solid black;</p>
<p class="p1"><span class="Apple-converted-space">    </span>}</p>
<p class="p1"><span class="Apple-converted-space">  </span>&lt;/style&gt;</p>
<p class="p1">&lt;/head&gt;</p>
<p class="p1">&lt;body&gt;</p>
<p class="p1"><span class="Apple-converted-space">  </span>&lt;h1&gt;Mapeo de Eventos sobre la Plantilla PNG&lt;/h1&gt;</p>
<p class="p1"><span class="Apple-converted-space">  </span>&lt;p&gt;Este ejemplo usa una transformación calculada a partir de 4 puntos de control fijos.&lt;/p&gt;</p>
<p class="p2"><span class="Apple-converted-space">  </span></p>
<p class="p1"><span class="Apple-converted-space">  </span>&lt;div id="mapContainer"&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;!-- Aquí se especifica la plantilla PNG. Asegúrate de que el archivo "mapa_plantilla.png" esté en la misma carpeta --&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;img id="mapImg" src="mapa_plantilla.png" alt="Mapa de CDMX"&gt;</p>
<p class="p1"><span class="Apple-converted-space">  </span>&lt;/div&gt;</p>
<p class="p2"><span class="Apple-converted-space">  </span></p>
<p class="p1"><span class="Apple-converted-space">  </span>&lt;script&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>/***** Puntos de control *****/</p>
<p class="p1"><span class="Apple-converted-space">    </span>// Nota: Para el cálculo de la homografía usaremos la convención:</p>
<p class="p1"><span class="Apple-converted-space">    </span>// srcPoints: puntos en coordenadas geográficas (x = lon, y = lat)</p>
<p class="p1"><span class="Apple-converted-space">    </span>// dstPoints: puntos en píxeles en la imagen</p>
<p class="p1"><span class="Apple-converted-space">    </span>const srcPoints = [</p>
<p class="p1"><span class="Apple-converted-space">      </span>// Tus puntos: (lat, lon) los convertimos a (x: lon, y: lat)</p>
<p class="p1"><span class="Apple-converted-space">      </span>{ x: -99.24322321, y: 19.35810519 },</p>
<p class="p1"><span class="Apple-converted-space">      </span>{ x: -99.25566,<span class="Apple-converted-space">    </span>y: 19.32702<span class="Apple-converted-space">    </span>},</p>
<p class="p1"><span class="Apple-converted-space">      </span>{ x: -98.98301473, y: 19.21595802 },</p>
<p class="p1"><span class="Apple-converted-space">      </span>{ x: -99.087433, <span class="Apple-converted-space">  </span>y: 19.443727 <span class="Apple-converted-space">  </span>}</p>
<p class="p1"><span class="Apple-converted-space">    </span>];</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>const dstPoints = [</p>
<p class="p1"><span class="Apple-converted-space">      </span>{ x: 60.7999,<span class="Apple-converted-space">  </span>y: 123.081 },</p>
<p class="p1"><span class="Apple-converted-space">      </span>{ x: 54.7369,<span class="Apple-converted-space">  </span>y: 138.311 },</p>
<p class="p1"><span class="Apple-converted-space">      </span>{ x: 188.055,<span class="Apple-converted-space">  </span>y: 192.519 },</p>
<p class="p1"><span class="Apple-converted-space">      </span>{ x: 137.035,<span class="Apple-converted-space">  </span>y: 81.1605 }</p>
<p class="p1"><span class="Apple-converted-space">    </span>];</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>/***** Funciones para calcular la homografía *****/</p>
<p class="p1"><span class="Apple-converted-space">    </span>// Resolver un sistema lineal A * x = b usando eliminación gaussiana</p>
<p class="p1"><span class="Apple-converted-space">    </span>function solveLinearSystem(A, b) {</p>
<p class="p1"><span class="Apple-converted-space">      </span>const n = b.length;</p>
<p class="p1"><span class="Apple-converted-space">      </span>// Aumentamos A con b (extendemos cada fila)</p>
<p class="p1"><span class="Apple-converted-space">      </span>for (let i = 0; i &lt; n; i++) {</p>
<p class="p1"><span class="Apple-converted-space">        </span>A[i].push(b[i]);</p>
<p class="p1"><span class="Apple-converted-space">      </span>}</p>
<p class="p1"><span class="Apple-converted-space">      </span>// Eliminación gaussiana</p>
<p class="p1"><span class="Apple-converted-space">      </span>for (let i = 0; i &lt; n; i++) {</p>
<p class="p1"><span class="Apple-converted-space">        </span>// Encontrar el pivote</p>
<p class="p1"><span class="Apple-converted-space">        </span>let maxRow = i;</p>
<p class="p1"><span class="Apple-converted-space">        </span>for (let k = i + 1; k &lt; n; k++) {</p>
<p class="p1"><span class="Apple-converted-space">          </span>if (Math.abs(A[k][i]) &gt; Math.abs(A[maxRow][i])) {</p>
<p class="p1"><span class="Apple-converted-space">            </span>maxRow = k;</p>
<p class="p1"><span class="Apple-converted-space">          </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>// Intercambiar filas</p>
<p class="p1"><span class="Apple-converted-space">        </span>[A[i], A[maxRow]] = [A[maxRow], A[i]];</p>
<p class="p1"><span class="Apple-converted-space">        </span>if (Math.abs(A[i][i]) &lt; 1e-10) {</p>
<p class="p1"><span class="Apple-converted-space">          </span>throw new Error("La matriz es singular");</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>// Eliminar las variables en filas inferiores</p>
<p class="p1"><span class="Apple-converted-space">        </span>for (let k = i + 1; k &lt; n; k++) {</p>
<p class="p1"><span class="Apple-converted-space">          </span>const factor = A[k][i] / A[i][i];</p>
<p class="p1"><span class="Apple-converted-space">          </span>for (let j = i; j &lt; n + 1; j++) {</p>
<p class="p1"><span class="Apple-converted-space">            </span>A[k][j] -= factor * A[i][j];</p>
<p class="p1"><span class="Apple-converted-space">          </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">      </span>}</p>
<p class="p1"><span class="Apple-converted-space">      </span>// Sustitución hacia atrás</p>
<p class="p1"><span class="Apple-converted-space">      </span>const x = new Array(n);</p>
<p class="p1"><span class="Apple-converted-space">      </span>for (let i = n - 1; i &gt;= 0; i--) {</p>
<p class="p1"><span class="Apple-converted-space">        </span>let sum = A[i][n];</p>
<p class="p1"><span class="Apple-converted-space">        </span>for (let j = i + 1; j &lt; n; j++) {</p>
<p class="p1"><span class="Apple-converted-space">          </span>sum -= A[i][j] * x[j];</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>x[i] = sum / A[i][i];</p>
<p class="p1"><span class="Apple-converted-space">      </span>}</p>
<p class="p1"><span class="Apple-converted-space">      </span>return x;</p>
<p class="p1"><span class="Apple-converted-space">    </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>// Calcula la matriz de homografía H (3x3) tal que:</p>
<p class="p1"><span class="Apple-converted-space">    </span>// [x, y, 1]^T ~ H * [lon, lat, 1]^T, usando h33 = 1</p>
<p class="p1"><span class="Apple-converted-space">    </span>function computeHomography(src, dst) {</p>
<p class="p1"><span class="Apple-converted-space">      </span>const A = [];</p>
<p class="p1"><span class="Apple-converted-space">      </span>const b = [];</p>
<p class="p1"><span class="Apple-converted-space">      </span>for (let i = 0; i &lt; 4; i++) {</p>
<p class="p1"><span class="Apple-converted-space">        </span>const X = src[i].x, Y = src[i].y;</p>
<p class="p1"><span class="Apple-converted-space">        </span>const x = dst[i].x, y = dst[i].y;</p>
<p class="p1"><span class="Apple-converted-space">        </span>// Dos ecuaciones por cada par</p>
<p class="p1"><span class="Apple-converted-space">        </span>A.push([X, Y, 1, 0, 0, 0, -x * X, -x * Y]);</p>
<p class="p1"><span class="Apple-converted-space">        </span>A.push([0, 0, 0, X, Y, 1, -y * X, -y * Y]);</p>
<p class="p1"><span class="Apple-converted-space">        </span>b.push(x);</p>
<p class="p1"><span class="Apple-converted-space">        </span>b.push(y);</p>
<p class="p1"><span class="Apple-converted-space">      </span>}</p>
<p class="p1"><span class="Apple-converted-space">      </span>const h = solveLinearSystem(A, b);</p>
<p class="p1"><span class="Apple-converted-space">      </span>h.push(1); // h33 = 1</p>
<p class="p1"><span class="Apple-converted-space">      </span>// Retornar H como una matriz 3x3</p>
<p class="p1"><span class="Apple-converted-space">      </span>return [</p>
<p class="p1"><span class="Apple-converted-space">        </span>[h[0], h[1], h[2]],</p>
<p class="p1"><span class="Apple-converted-space">        </span>[h[3], h[4], h[5]],</p>
<p class="p1"><span class="Apple-converted-space">        </span>[h[6], h[7], h[8]]</p>
<p class="p1"><span class="Apple-converted-space">      </span>];</p>
<p class="p1"><span class="Apple-converted-space">    </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>// Aplica la homografía H a un punto dado (lon, lat)</p>
<p class="p1"><span class="Apple-converted-space">    </span>function applyHomography(H, pt) {</p>
<p class="p1"><span class="Apple-converted-space">      </span>// pt: { x: lon, y: lat }</p>
<p class="p1"><span class="Apple-converted-space">      </span>const X = pt.x, Y = pt.y;</p>
<p class="p1"><span class="Apple-converted-space">      </span>const denom = H[2][0] * X + H[2][1] * Y + H[2][2];</p>
<p class="p1"><span class="Apple-converted-space">      </span>const x = (H[0][0] * X + H[0][1] * Y + H[0][2]) / denom;</p>
<p class="p1"><span class="Apple-converted-space">      </span>const y = (H[1][0] * X + H[1][1] * Y + H[1][2]) / denom;</p>
<p class="p1"><span class="Apple-converted-space">      </span>return { x, y };</p>
<p class="p1"><span class="Apple-converted-space">    </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>// Calcula la matriz de homografía usando los puntos de control</p>
<p class="p1"><span class="Apple-converted-space">    </span>const H = computeHomography(srcPoints, dstPoints);</p>
<p class="p1"><span class="Apple-converted-space">    </span>console.log("Matriz de Homografía:", H);</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>/***** Función para marcar eventos *****/</p>
<p class="p1"><span class="Apple-converted-space">    </span>function marcarEvento(lat, lon, color = "red") {</p>
<p class="p1"><span class="Apple-converted-space">      </span>// Recuerda: para nuestra función, convertimos a {x: lon, y: lat}</p>
<p class="p1"><span class="Apple-converted-space">      </span>const ptGeo = { x: lon, y: lat };</p>
<p class="p1"><span class="Apple-converted-space">      </span>const ptPixel = applyHomography(H, ptGeo);</p>
<p class="p2"><span class="Apple-converted-space">      </span></p>
<p class="p1"><span class="Apple-converted-space">      </span>const marker = document.createElement("div");</p>
<p class="p1"><span class="Apple-converted-space">      </span>marker.className = "marker";</p>
<p class="p1"><span class="Apple-converted-space">      </span>marker.style.backgroundColor = color;</p>
<p class="p1"><span class="Apple-converted-space">      </span>// Ajusta la posición para centrar el marcador (12px de tamaño)</p>
<p class="p1"><span class="Apple-converted-space">      </span>marker.style.left = (ptPixel.x - 6) + "px";</p>
<p class="p1"><span class="Apple-converted-space">      </span>marker.style.top = (ptPixel.y - 6) + "px";</p>
<p class="p2"><span class="Apple-converted-space">      </span></p>
<p class="p1"><span class="Apple-converted-space">      </span>document.getElementById("mapContainer").appendChild(marker);</p>
<p class="p1"><span class="Apple-converted-space">    </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>/***** Ejemplo de uso *****/</p>
<p class="p1"><span class="Apple-converted-space">    </span>// Por ejemplo, marcar un evento en CDMX con coordenadas (lat, lon) = (19.4326, -99.1332)</p>
<p class="p1"><span class="Apple-converted-space">    </span>// Recuerda que para aplicar la transformación, se asume que el PNG es fijo y los puntos de control definidos son válidos.</p>
<p class="p1"><span class="Apple-converted-space">    </span>marcarEvento(19.4326, -99.1332, "blue");</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>// Puedes agregar más llamadas a marcarEvento(lat, lon, color) según tus necesidades.</p>
<p class="p1"><span class="Apple-converted-space">  </span>&lt;/script&gt;</p>
<p class="p1">&lt;/body&gt;</p>
<p class="p1">&lt;/html&gt;</p>
</body>
</html>
